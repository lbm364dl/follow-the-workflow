<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8&nbsp; Project structure – Follow the workflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./intro.html" rel="next">
<link href="./r.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-12c4be15c1b1427f4ba784337d14fbb2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./r.html">R part</a></li><li class="breadcrumb-item"><a href="./r-pkg.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Project structure</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Follow the workflow</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Git part</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clone-repo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Cloning the repository</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pull-remote.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Pulling remote changes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./create-branch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Creating our own branch</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./add-changes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Adding changes to our branch</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./push-changes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Pushing our changes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./create-pr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Creating a pull request</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./solve-conflicts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Solving conflicts</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R part</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./r-pkg.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Project structure</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Summary</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#virtual-environments-with-renv" id="toc-virtual-environments-with-renv" class="nav-link active" data-scroll-target="#virtual-environments-with-renv"><span class="header-section-number">8.1</span> Virtual environments with renv</a></li>
  <li><a href="#writing-code" id="toc-writing-code" class="nav-link" data-scroll-target="#writing-code"><span class="header-section-number">8.2</span> Writing code</a></li>
  <li><a href="#function-documentation" id="toc-function-documentation" class="nav-link" data-scroll-target="#function-documentation"><span class="header-section-number">8.3</span> Function documentation</a></li>
  <li><a href="#package-data" id="toc-package-data" class="nav-link" data-scroll-target="#package-data"><span class="header-section-number">8.4</span> Package data</a></li>
  <li><a href="#writing-tests" id="toc-writing-tests" class="nav-link" data-scroll-target="#writing-tests"><span class="header-section-number">8.5</span> Writing tests</a></li>
  <li><a href="#r-cmd-check" id="toc-r-cmd-check" class="nav-link" data-scroll-target="#r-cmd-check"><span class="header-section-number">8.6</span> R CMD Check</a></li>
  <li><a href="#writing-articles" id="toc-writing-articles" class="nav-link" data-scroll-target="#writing-articles"><span class="header-section-number">8.7</span> Writing articles</a></li>
  <li><a href="#environment-variables-and-secrets" id="toc-environment-variables-and-secrets" class="nav-link" data-scroll-target="#environment-variables-and-secrets"><span class="header-section-number">8.8</span> Environment variables and secrets</a></li>
  <li><a href="#r-code-style-and-formatting" id="toc-r-code-style-and-formatting" class="nav-link" data-scroll-target="#r-code-style-and-formatting"><span class="header-section-number">8.9</span> R code style and formatting</a></li>
  <li><a href="#reading-large-files" id="toc-reading-large-files" class="nav-link" data-scroll-target="#reading-large-files"><span class="header-section-number">8.10</span> Reading large files</a></li>
  <li><a href="#automatic-checks-on-pull-requests" id="toc-automatic-checks-on-pull-requests" class="nav-link" data-scroll-target="#automatic-checks-on-pull-requests"><span class="header-section-number">8.11</span> Automatic checks on Pull Requests</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./r.html">R part</a></li><li class="breadcrumb-item"><a href="./r-pkg.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Project structure</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Project structure</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>It seems clear that even though we would work fine with bare R scripts that are run directly, when working on a large project it makes sense to have some kind of file structure, to keep everything organized. You can build your ad-hoc file structures, and you could probably come up with something rather simple. Here, instead, we will focus on using the standard structure of an R package. This is a standard everyone has to follow if they want their projects to turn into packages which can be publicly downloaded by anyone from the <a href="https://cran.r-project.org/">CRAN repositories</a>. Just the same way you do, e.g., <code>install.packages(tidyverse)</code> to install all Tidyverse packages, if you follow this standard R package structure, you can upload your package and one could do <code>install.packages(your_package)</code> the same way.</p>
<p>Even if you do not want to upload a package, there are still advantages if you follow this structure. This is the one we will follow, so the rest of this section will try to explain its different parts, that will all become part of our workflow.</p>
<p>This is the whole structure of an R package:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/r_package_structure.png" class="img-fluid figure-img" alt="Structure of an R package"></p>
</figure>
</div>
</div>
</div>
<p>Luckily, there are a lot of files there that you do not need to know about, at least for now, so we will try to explain the most important ones in the next sections.</p>
<p>There is a whole <a href="https://r-pkgs.org/">R packages book</a> which I followed myself to setup the basics for our project. It is very well written and available for free online, so if you are interested in knowing more about R packages and their project structure, I recommend checking the book.</p>
<section id="virtual-environments-with-renv" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="virtual-environments-with-renv"><span class="header-section-number">8.1</span> Virtual environments with renv</h2>
<p>We just mentioned we were going to use the R package structure, and it seems R package developers do not use <code>renv</code>… Or do they? At least they do not seem to include <code>renv</code> related files in their package repositories… Well, why should <em>we</em> use it then? While writing this guide I was a bit confused myself about mixing both things, but my conclusion was that it just does not hurt in any way, <code>renv</code> just makes things easier without apparent drawbacks (do tell me if you know of any). When creating packages, you want to make sure they work on fresh installations, i.e., computers that do not have anything unnecessary installed. The package creation process as we will use it, does not need to know anything about <code>renv</code>, so we should be fine. The packages use their own file called <code>DESCRIPTION</code> which includes information about the other packages it needs as dependencies, as we will see later on. So we can just try to benefit from using virtual environments.</p>
<p>OK, but what are virtual environments? This is a fancy term, but its practical meaning is quite simple. First consider the following:</p>
<ul>
<li>If you are not using them, it means you just have a global R installation in your computer, and whenever you install a package, it is installed globally.</li>
<li>If you want to run someone’s code and they use a bunch of packages that you usually do not, you would have to install all of them to be able to run their code, and these would mix with all your other packages. If you want to uninstall them after that, you would have to do a lot of manual work to make sure you know all of them (some package dependencies could have also been installed, and you cannot be sure if they were only used for these packages or also some other package that you already had).</li>
<li>If you want to write some code that uses some packages, and you want another person to run it, you should make a list of the packages used only in this project, because they should not have to install any other packages you have from other projects but are not necessary here. If you do not even make this ‘package list’, the other person should have to go through your whole code or run it and install a new package every time the code fails because of a missing one. Overall, this is a poor experience.</li>
</ul>
<p>Virtual environments try to fix this. Essentially, they provide a ‘local’ installation of packages, that are only visible inside your project, and do not get mixed at all with those from your global R installation or from other individual projects. In practice, a virtual environment is just a folder containing installed packages, isolated from the folder that contains your global R installation. It is like having several different R installations, each one with their own packages and versions.</p>
<p>Chances are you follow this guide with an existing repository that is already using <code>renv</code> (then you can skip the <code>renv::init()</code> step). If this were not the case, open an R prompt in the root directory of your project and run inside the prompt:</p>
<pre><code>renv::init()</code></pre>
<p>It will probably ask to close and reopen a clean prompt. After that, every time we open an R prompt inside our project, it will automatically use <code>renv</code> to work within a virtual environment. If you use <code>renv</code> for the first time but on a project that already uses it, when you open the R prompt in its root directory, the <code>renv</code> package will be installed automatically.</p>
<p>Now that we have <code>renv</code>, we can, for example, install a testing package with <code>install.packages("testthat")</code> and this will not be a global installation, which means it will only work inside this project. This is a way of isolating your project dependencies and making your projects reproducible, by letting others know exactly which packages your code needs to run, and not add unnecessary ones that you may have because of other projects, as we mentioned previously.</p>
<p>The ‘list’ of required packages for the project, along with their versions, which is used by <code>renv</code> to manage the virtual environment, is in a file called <code>renv.lock</code>. After installing new packages, this file is not updated automatically and we have to do it manually by running</p>
<pre><code>renv::snapshot()</code></pre>
<p>This will update the <code>renv.lock</code> file with all the packages <code>renv</code> finds are used in your code. If for some reason you need to install a package not explicitly used in the code, this may fail to recognize it. In that case, you should instead explicitly call <code>renv::snapshot(type="all")</code> to force every package in your <code>renv</code> environment to be added to <code>renv.lock</code>. You should push this file to the repository. If someone else wants to reproduce your code, then they may have to run</p>
<pre><code>renv::restore()</code></pre>
<p>which will install any packages from <code>renv.lock</code> that they may still not have installed, but again, only on a project level, not conflicting with their global R installation. If you use GitHub with others, then you might also need to do this every time you pull remote changes and someone else has included a new package, so that you are then up to date with them. In any case, when opening the R shell, it will probably remind you that there are missing packages in your virtual environment with a message:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/renv_warn_packages_not_installed.png" class="img-fluid figure-img" alt="renv warns packages not installed"></p>
</figure>
</div>
</div>
</div>
<p>And this is basically all you need to start using a virtual environment, keeping in mind the commands</p>
<ul>
<li><code>renv::snapshot()</code>: add new required packages to <code>renv.lock</code> file</li>
<li><code>renv::restore()</code>: install packages from <code>renv.lock</code> that you do not have yet</li>
</ul>
<p>I wrote this introduction to <code>renv</code> by reading their own package documentation. If you want to learn more about it, you can read it yourself at <a href="https://rstudio.github.io/renv/articles/renv.html">their package website</a>.</p>
<p>While this is not directly related to <code>renv</code> usage, I wanted to highlight here that in Windows you may have errors trying to install some R packages. Most of the times this may be related to missing operating system dependencies or commands. In Windows this should be easily fixable by installing the version of <a href="https://cran.r-project.org/bin/windows/Rtools/">Rtools</a> that matches with your R version. After selecting the version you can download it by clicking the first installer link. After installing Rtools, you can try again to install the R packages you wanted.</p>
</section>
<section id="writing-code" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="writing-code"><span class="header-section-number">8.2</span> Writing code</h2>
<p>Looking back at the package’s file structure, it is in the <code>R/</code> directory where we will put all the main code. The R files stored here must not contain any top-level code, that is, it must all be inside functions. We can add more than one function in each file if they are somehow related, but there must not be too many either. If a file becomes too large and it has several functions inside, consider splitting it into shorter files.</p>
<p>Take the following code as an example, written by our colleague Justin (you do not have to understand the code, you can keep reading). We save it in <code>R/sources.R</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Create a new dataframe where each row has a year range into one where each</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' row is a single year, effectively 'expanding' the whole year range</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param trade_sources A tibble dataframe</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' where each row contains the year range</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns A tibble dataframe where each row</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' corresponds to a single year for a given source</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' trade_sources &lt;- tibble::tibble(</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Name = c("a", "b", "c"),</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Trade = c("t1", "t2", "t3"),</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Info_Format = c("year", "partial_series", "year"),</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Timeline_Start = c(1, 1, 2),</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Timeline_End = c(3, 4, 5),</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Timeline_Freq = c(1, 1, 2),</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `Imp/Exp` = "Imp",</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">#'   SACO_link = NA,</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' )</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' expand_trade_sources(trade_sources)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>expand_trade_sources <span class="ot">&lt;-</span> <span class="cf">function</span>(trade_sources) {</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  non_na_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Trade"</span>, <span class="st">"Timeline_Start"</span>, <span class="st">"Timeline_End"</span>, <span class="st">"Timeline_Freq"</span>)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  trade_sources <span class="sc">|&gt;</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">.any_na_col</span>(non_na_cols)) <span class="sc">|&gt;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.expand_trade_years</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">Name =</span> dplyr<span class="sc">::</span><span class="fu">if_else</span>(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        Info_Format <span class="sc">==</span> <span class="st">"year"</span>, <span class="fu">paste</span>(Name, Year, <span class="at">sep =</span> <span class="st">"_"</span>), Name</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">ImpExp =</span> <span class="st">`</span><span class="at">Imp/Exp</span><span class="st">`</span>,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">In_Saco =</span> <span class="fu">as.integer</span>(<span class="sc">!</span><span class="fu">is.na</span>(SACO_link)),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>.expand_trade_years <span class="ot">&lt;-</span> <span class="cf">function</span>(trade_sources) {</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  trade_sources <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(trade_sources, <span class="at">No =</span> dplyr<span class="sc">::</span><span class="fu">row_number</span>())</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  trade_sources <span class="sc">|&gt;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(No) <span class="sc">|&gt;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">expand</span>(<span class="at">Year =</span> <span class="fu">seq</span>(Timeline_Start, Timeline_End, Timeline_Freq)) <span class="sc">|&gt;</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(trade_sources, <span class="at">by =</span> <span class="st">"No"</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>.any_na_col <span class="ot">&lt;-</span> <span class="cf">function</span>(cols_to_check) {</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">if_any</span>(dplyr<span class="sc">::</span><span class="fu">all_of</span>(cols_to_check), is.na)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this sample code there are some things to keep in mind:</p>
<ul>
<li>All the code is written inside functions, and there are three of them. The name of two of them starts with a dot. This is a convention for private functions. Private functions are just helpers that are used in other functions from the same file, they do not need to be used from outside.</li>
<li>The functions that are not private, are then called public, and those are the ones that we want to ‘export’, in the sense that we want to allow for them to be used from outside this file. In our <code>sources.R</code> example, the first function is public.</li>
<li>The public function has a large commented section before it, each line starting with <code>#'</code>. This is a special type of comment and it is considered documentation. Every public function <strong>must</strong> be documented in the same way (more on this special function documentation in the next section). The private functions can be introduced by explanatory comments if you consider it necessary, but they should be normal comments instead (starting with just <code>#</code>, without the single quote).</li>
</ul>
<p>The most important take from here anyway is that these files should contain all the code inside functions and nothing outside them.</p>
</section>
<section id="function-documentation" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="function-documentation"><span class="header-section-number">8.3</span> Function documentation</h2>
<p>The special commented section seen in the previous example will be used by a package called <a href="https://roxygen2.r-lib.org/"><code>roxygen2</code></a>. We have to follow this exact syntax, so that this package can automatically build a really neat documentation of our package for us. Let’s try to understand its basic structure. For reference, these were the different parts:</p>
<ul>
<li>A small description of the function, nothing else.</li>
</ul>
<pre><code>#' Create a new dataframe where each row has a year range into one where each
#' row is a single year, effectively 'expanding' the whole year range</code></pre>
<ul>
<li>A small description of each parameter the function receives. It should be like:</li>
</ul>
<pre><code>#' @param param_name_1 Description of param 1
#' @param param_name_2 Description of param 2
#' ...</code></pre>
<p>As you see here I think it is OK to add line breaks in between, as long as each parameter starts with <code>@param</code>.</p>
<pre><code>#' @param trade_sources A tibble dataframe
#' where each row contains the year range</code></pre>
<ul>
<li>A small description of the value the function returns. It should start with <code>@returns</code>.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns A tibble dataframe where each row</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' corresponds to a single year for a given source</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>A simple line containing <code>@export</code> to indicate the function can be used in the package, i.e., it is public.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>A ‘code’ section of examples to illustrate the function’s behavior. It must start with <code>@examples</code>, and after that you can write usual R code. When this is processed, it automatically runs the code and adds some lines with its output in the documentation.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' trade_sources &lt;- tibble::tibble(</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Name = c("a", "b", "c"),</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Trade = c("t1", "t2", "t3"),</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Info_Format = c("year", "partial_series", "year"),</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Timeline_Start = c(1, 1, 2),</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Timeline_End = c(3, 4, 5),</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Timeline_Freq = c(1, 1, 2),</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'   `Imp/Exp` = "Imp",</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'   SACO_link = NA,</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' )</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' expand_trade_sources(trade_sources)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These options are enough to get us started with a nice documentation. In the <a href="#writing-articles">Writing articles</a> section we will learn how to generate and see this documentation. In this example, it would look something like this (note the autogenerated example code output):</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/roxygen_documentation.png" class="img-fluid figure-img" alt="Auto generated documentation appearance"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="package-data" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="package-data"><span class="header-section-number">8.4</span> Package data</h2>
<p>Some of the data we have to work with might be very large. If the final datasets we want to produce are too large, we can’t directly include them in the package because there are size limits and recommendations. In that case, we will have to export them as <em>functions</em>. In this way, the package itself won’t contain the output dataset, but the user will have to generate it through running a function, so it will be stored in their own computer. An example of this is our function <code>get_wide_cbs()</code>. Unless we generate the dataset ourselves in the function, we will also probably be using a very large input dataset which we just process somehow. For reading large datasets, see the relevant <a href="#reading-large-files">Reading large files section</a>.</p>
<p>From now on, in this section we assume that you have some small datasets (maybe up to a couple of megabytes) as inputs. We will go through both public and private ones. The public ones are those that you want to export to users of your package, and the private ones are only intended for being used in your own code.</p>
<p>Let’s start with the exported datasets. The whole aim of this is to allow users (or even our own code) to access them easily by writing <code>my_pkg::my_dataset</code>. In order to achieve this, you must follow these steps:</p>
<ol type="1">
<li><p>Create a file in <code>data-raw/my_dataset.R</code>. Scripts inside the <code>data-raw</code> folder aren’t included as part of the package. They will just be helpers for us to generate the actual data. Inside this file we do some processing and, assuming we have a variable called <code>my_dataset</code>, we end the script by calling <code>usethis::use_data(my_dataset)</code>. This will automatically create an <code>.rda</code> file in <code>data/my_dataset.rda</code>. We have to manually run this script. After that, we can now refer to the dataset as <code>my_pkg::my_dataset</code>.</p>
<p>You can directly create your data in the script <code>data-raw/my_dataset.R</code>, or you can make it rather short by just importing some data from another raw file. In this case, I recommend having the raw file as a CSV in the <code>inst/extdata</code> folder, say, <code>inst/extdata/my_raw_dataset.csv</code>. This is for accessibility, so that everyone can see where this data comes from regardless of whether they know how to read an <code>.rda</code> file or not. A <code>data-raw/my_dataset.R</code> script could then look like:</p></li>
</ol>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>my_dataset <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"inst"</span>, <span class="st">"extdata"</span>, <span class="st">"my_raw_dataset.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_data</span>(my_raw_dataset, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Every time you introduce some change in the raw CSV file, you would have to run this script again. The <code>overwrite = TRUE</code> is exactly for this purpose, so that the <code>my_dataset.rda</code> file is overwritten with the updated data.</p>
<ol start="2" type="1">
<li>Document your dataset. In the previous section we learned how to document functions. Datasets aren’t functions, but they’re documented very similarly. We start by creating a file <code>R/my_dataset.R</code>. Note that the name matches that of <code>data-raw/my_dataset.R</code>. It doesn’t need to match that of the variable used with <code>usethis::use_data()</code>, but they should match each other. You can define more than one dataset in the same file if you think they’re related, so then you can also use a more general name for the file. This is how you would document your dataset, also using <code>roxygen2</code> comments:</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Title of my dataset</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' My description of my dataset</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @format</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' What my dataset is. I would ideally make it a tibble and explain all</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' columns. My dataset contains the following columns:</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `column_1`: My explanation of column 1.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `column_2`: My explanation of column 2.</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' - `column_3`: My explanation of column 3.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @source Where my data comes from. Maybe an external link if you have one.</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="st">"my_dataset"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you can see, we use <code>roxygen2</code> style comments right before a line containing a character vector with the name of our dataset, in this case <code>"my_dataset"</code>. Now your dataset will be correctly documented after doing <code>devtools::document()</code> and <code>pkgdown::build_site()</code>/<code>pkgdown::build_reference()</code>.</p>
<p>Now we should talk about internal data. This is data that only the developers of the package themselves use throughout the code. This could be either actual tibble datasets or just bare constants. Any value that doesn’t change and you would like to share throughout the whole package code applies for this. Creating internal data is quite similar to exported data:</p>
<ol type="1">
<li>Create a file <code>data-raw/constants.R</code> if it doesn’t already exist. For internal data, all of them should be defined in this same file. The file could look like this:</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>my_constant_number <span class="ot">&lt;-</span> <span class="fl">0.65</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>my_constant_name <span class="ot">&lt;-</span> <span class="st">"name"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>my_constant_tibble <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>col_1, <span class="sc">~</span>col_2,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>,      <span class="dv">2</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>,      <span class="dv">4</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_data</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  my_constant_number,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  my_constant_name,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  my_constant_tibble,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">internal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you can see, you can pass more than one variable to <code>usethis::use_data()</code>. We should include all our constants in the same call to this function. In addition, it must also include the <code>internal = TRUE</code> option to identify this as internal data.</p>
<ol start="2" type="1">
<li>Manually run the previous file. This will create a single file in <code>R/sysdata.rda</code>, which contains all your internal data. You can now refer to these data the same way as for exported data, e.g., <code>my_pkg::my_constant_tibble</code> or <code>my_pkg::my_constant_number</code>, but these will only be available through the package’s code, and won’t be exported to the package users. Again, any time you want to add new internal data or modify the existing entries, you will have to manually run that script again.</li>
</ol>
<p>Whether some data is worth being exported as part of the package or just used as internal, this is your decision, but now you know how to implement both. This section was heavily inspired by the <a href="https://r-pkgs.org/data.html"><em>Data</em> chapter</a> in the R Packages book, which I recommend reading if you want to dive deeper.</p>
</section>
<section id="writing-tests" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="writing-tests"><span class="header-section-number">8.5</span> Writing tests</h2>
<p>So we just wrote a function, we are done with it, we now move to another function… No.&nbsp;You probably thought that we should check somehow that this function is indeed correct and it does what you expect. Right now it would be easy to just load the function in an R prompt and try some examples on it, but what if the next month someone has to make a change in this code? They would have to do this manual testing again to make sure they did not break any functionality. What if they need to change dozens of functions? How much time will they spend on testing all of them?</p>
<p>I think you can understand that this is really time consuming and that there is a better way. Tests can be automatized. We can write some tests whenever we create a new function, that together prove the function does what we expect, and if later on we add some changes to the function, we already have a test that can be run automatically to see if the function is still correct. Of course, this is not completely accurate. Maybe when we changed the function, some of its functionality was also changed, so the test is not accurate anymore and has to be tweaked as well, to represent what we really want. But this is still much less work than always testing the function manually in an R prompt, and eventually you just get used to it.</p>
<p>The package that is used to write tests and is well integrated into the R package creation workflow is <a href="https://testthat.r-lib.org/index.html">testthat</a>. We will be using it to write our automated tests. Again, looking at the structure of an R package, the tests go into (surprise!) the directory <code>tests/</code>. In this directory there is a file called <code>testthat.R</code> that setups <code>testthat</code> and should not be changed, and the actual tests that we write will go into the <code>tests/testthat/</code> subdirectory. The convention is to name the test files the same way as the R files but with a <code>test-</code> prefix. In our case, for example, if we have an R file in <code>R/sources.R</code>, then our test file should be <code>tests/testthat/test-sources.R</code>. Let’s see how one of our tests could look like:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"testthat"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"trade source data is expanded from year range to single year rows"</span>, {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  trade_sources <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Name =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"d"</span>, <span class="st">"e"</span>),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Trade =</span> <span class="fu">c</span>(<span class="st">"t1"</span>, <span class="st">"t2"</span>, <span class="st">"t3"</span>, <span class="cn">NA</span>, <span class="st">"t5"</span>),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Info_Format =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"partial_series"</span>, <span class="st">"year"</span>, <span class="st">"year"</span>, <span class="st">"year"</span>),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Timeline_Start =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Timeline_End =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Timeline_Freq =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="cn">NA</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Imp/Exp</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"Imp"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">SACO_link =</span> <span class="cn">NA</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Name =</span> <span class="fu">c</span>(<span class="st">"a_1"</span>, <span class="st">"a_2"</span>, <span class="st">"a_3"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">"c_2"</span>, <span class="st">"c_4"</span>),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Trade =</span> <span class="fu">c</span>(<span class="st">"t1"</span>, <span class="st">"t1"</span>, <span class="st">"t1"</span>, <span class="st">"t2"</span>, <span class="st">"t2"</span>, <span class="st">"t2"</span>, <span class="st">"t2"</span>, <span class="st">"t3"</span>, <span class="st">"t3"</span>),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Info_Format =</span> <span class="fu">c</span>(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">"year"</span>, <span class="st">"year"</span>, <span class="st">"year"</span>, <span class="st">"partial_series"</span>, <span class="st">"partial_series"</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">"partial_series"</span>, <span class="st">"partial_series"</span>, <span class="st">"year"</span>, <span class="st">"year"</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Year =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  actual <span class="ot">&lt;-</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    trade_sources <span class="sc">|&gt;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expand_trade_sources</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(actual, Name, Trade, Info_Format, Year),</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    expected</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Again, you do not have to understand the whole code. Just note that we use two functions from the <code>testthat</code> package:</p>
<ul>
<li><code>testthat::test_that</code>: this is the main function used to delimit what a test is. It receives a text description about what the test is checking, and a body containing all the code of the test itself.</li>
<li><code>testthat::expect_equal</code>: this is just one of the many utilities <code>testthat</code> brings to actually assert things in the test’s code. It is probably the most general assert, and it just checks if everything is identical in both arguments, including internal object metadata, not just “appearance” (what you may see when printing an object). You can look for more testing utility functions in <a href="https://testthat.r-lib.org/reference/index.html">their documentation</a>.</li>
</ul>
<p>So now we have a test. How do we execute it? It is not recommended to run the test as usual R code (e.g.&nbsp;run the file as a script). Instead, there are some functions provided by <code>testthat</code> for running tests. Here are some of them:</p>
<ul>
<li><code>testthat::auto_test_package()</code>: This one will run all the tests in the package the first time, and after that it will not stop running, but wait for code changes. This means that whenever you ‘save’ a test file, it only reruns all the tests in that file. This is extremely useful when you are actively writing some tests, so that you can get fast feedback.</li>
<li><code>testthat::test_file()</code>: This one receives as argument the path to a test file, and it only runs the tests inside it. For example, we could run in our case <code>testthat::test_file("tests/testthat/test-sources.R")</code>.</li>
<li><code>testthat::test_dir()</code>: In this case, this could be different to running all the tests if we had e.g.&nbsp;some subdirectories in the <code>tests/testthat</code> one. If there was a subdirectory <code>tests/testthat/sources</code> with many test files related to sources, we could run <code>testthat::test_dir("tests/testthat/sources")</code> and all test files inside this directory would be executed.</li>
<li><code>testthat::test_package()</code>: This is the most general one. It just runs all the tests in the project.</li>
</ul>
<p>All of these can be useful to run tests while you are actively working on them. You are supposed to make all your tests pass, and as we will see in the next section, there are some more checks a package must pass to be valid (so that it can be publicly uploaded), but tests are definitely one of them.</p>
</section>
<section id="r-cmd-check" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="r-cmd-check"><span class="header-section-number">8.6</span> R CMD Check</h2>
<p>There is a standard tool that contains several steps (‘checks’) which every project that wants to be a package uploaded to <a href="https://cran.r-project.org/">CRAN repositories</a> must pass. As part of our code workflow, you are also responsible to make this check pass, as we will also see in the <a href="#automatic-checks-on-pull-requests">Automatic checks on Pull Requests</a> section. This check is known as ‘R CMD check’, and it is actually very easy to run:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">check</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The whole output of this call is rather long, since it lists all the different checks it makes, but at the end, if there are no issues, this is the output you should see:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/r_cmd_check_pass.png" class="img-fluid figure-img" alt="Correct output of R CMD check"></p>
</figure>
</div>
</div>
</div>
<p>OK, but if you just followed the steps in this guide and included our example code from the <a href="#writing-code">Writing code</a> and <a href="#writing-tests">Writing tests</a> sections, the above check should not have ended successfully with 0 errors, and you probably see (among the really large output), some error like this:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/r_cmd_check_fail.png" class="img-fluid figure-img" alt="Error no package called tidyr"></p>
</figure>
</div>
</div>
</div>
<p>The problem here is that before performing the check on your package, it must build it. And for that, it must know which other packages it has as dependencies. Again, if you just followed everything from here, we never got to do that, so your built package just does not include any other packages. To fix this, we must have a quick look at the <code>DESCRIPTION</code> file.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="an">Package:</span><span class="co"> whep</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="an">Title:</span><span class="co"> What the Package Does (One Line, Title Case)</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="an">Version:</span><span class="co"> 0.0.0.9000</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>Authors@R:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    person("First", "Last", , "first.last@example.com", role = c("aut", "cre"))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>Description: What the package does (one paragraph).</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>License: MIT + file LICENSE</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>Imports:</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    dplyr,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    tidyr</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>Encoding: UTF-8</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>Roxygen: list(markdown = TRUE)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>RoxygenNote: 7.3.2</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>Suggests:</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    knitr,</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    rmarkdown,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    testthat (&gt;= 3.0.0),</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    tibble,</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    ggplot2,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    here,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    googlesheets4</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>Config/testthat/edition: 3</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>VignetteBuilder: knitr</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>URL: https://eduaguilera.github.io/whep/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the above file, the <code>Imports</code> section is where we should make sure we have all dependencies for code which was saved specifically in the <code>R/</code> directory. On the other hand, dependencies for code written in other places, such as <code>tests/</code> or <code>vignettes/</code> (we will see this one in the following <a href="#writing-articles">Writing articles</a> section), should be included in the <code>Suggests</code> section of the <code>DESCRIPTION</code> file. Together these two fields tell everyone which dependencies our package needs to work correctly. After adding these, you could run again <code>devtools::check()</code> and confirm that it does not fail anymore (at least no errors).</p>
<p>We will not go into detail as to which checks are being performed. We will all slowly learn about them whenever they show up as real issues in our code when running the check tool. Just keep in mind that one of the important points is that all the tests you write are also executed here, and the ‘R CMD check’ also fails if one of your tests fail. If you really want to know more about the checks, you can read, e.g., <a href="https://r-pkgs.org/R-CMD-check.html">this detailed list</a>.</p>
</section>
<section id="writing-articles" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="writing-articles"><span class="header-section-number">8.7</span> Writing articles</h2>
<p>If you ever got to check some popular R package website (e.g.&nbsp;<a href="https://dplyr.tidyverse.org/index.html">dplyr</a>), you may know there is a section called <code>Articles</code> at the top, and if you open one of them, you see what indeed looks like an article, mixing natural text and code rendering. This is ideal if you want to make guides about your package, or some kind of reports in general. As you can probably guess, this guide that you are reading was built the same way. Luckily this is already very well integrated with the R packages workflow, and we will learn how to make our own articles here easily.</p>
<p>Everything that we want to appear in this <code>Articles</code> section of the site, should be included in the <code>vignettes/</code> directory of the package. And inside this directory, each file that ends with a <code>.Rmd</code> extension will be considered one article. The extension name stands for ‘R Markdown’, which is a mix of R code and Markdown text. If you do not know about Markdown you can start with, e.g., <a href="https://www.markdownguide.org/basic-syntax/">this intro</a>. Following our previous example, we can create a file called <code>trade-sources-coverage.Rmd</code> with the following code <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> (again, thanks to Justin):</p>
<pre><code>---
title: "Trade sources year coverage"
output: rmarkdown::html_vignette
vignette: &gt;
  %\VignetteIndexEntry{Trade sources year coverage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```_{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#&gt;"
)
```

```_{r setup}
library(whep)
key_path &lt;- here::here(Sys.getenv("GOOGLESHEETS_AUTH_FILE"))
googlesheets4::gs4_auth(path = key_path)
```

First we read the trade sources sheet and build a dataframe where each row accounts for one year.
```_{r}
# Step 1: Authentication
sheet_url &lt;- "1UdwgS87x5OsLjNuKaY3JA01GoI5nwsenz62JXCeq0GQ"

# PART 1: trade_sources FOR TRADE

# Step 2: Rest of Program
expanded_trade_sources &lt;-
  sheet_url |&gt;
  googlesheets4::read_sheet(sheet = "Final_Sources_Trade") |&gt;
  expand_trade_sources()
```

Now we build some plots.

Plot showing years covered by `expanded_trade_sources`:
```_{r, fig.alt="Plot showing years covered by expanded_trade_sources"}
ggplot2::ggplot(
  expanded_trade_sources,
  ggplot2::aes(y = Trade, x = Year, fill = "lightblue")
) +
  ggplot2::geom_tile(alpha = .8) +
  ggplot2::theme_dark() +
  ggplot2::labs(title = "Source Availability by Country") +
  ggplot2::scale_fill_identity() +
  ggplot2::facet_wrap(~Reporter, ncol = 1)
```</code></pre>
<p>The first part of this code, namely the following</p>
<pre><code>---
title: "Trade sources year coverage"
output: rmarkdown::html_vignette
vignette: &gt;
  %\VignetteIndexEntry{Trade sources year coverage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```_{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#&gt;"
)
```</code></pre>
<p>is metadata and should always be present (just change the article’s title). You see that just as in Markdown, we can write R code chunks inside triple backticks, but the difference here is that this code will be executed, and by default we will also be able to see its output in the rendered article.</p>
<p>The next chunk (with the <code>"r setup"</code> option) is used for some initialization code that you may need throughout the rest of the article. At the time of writing I do not really know the implications of writing the <code>"r setup"</code> option or writing this code in a normal R code chunk (without the option), but it is at least good practice. Note that the package being loaded is your own package (called whep in our case).</p>
<pre><code>```_{r setup}
library(whep)
key_path &lt;- here::here(Sys.getenv("GOOGLESHEETS_AUTH_FILE"))
googlesheets4::gs4_auth(path = key_path)
```</code></pre>
<p>The rest of the code provided is just some usual Markdown text intertwined with usual R code chunks. In the special case of code chunks with plots, we will get to see the actual plot in the rendered article, and the <code>fig.alt</code> option is necessary in order not to get an R CMD check warning, and will only be used as text which explains the rendered image for people using screen readers or in the case it cannot be displayed correctly in a browser.</p>
<p>Now that we have our R Markdown article, we would like to visualize it. There are at least two useful R commands for this. The first one creates the whole documentation website locally in our computers, and it automatically opens your browser on the site. This is simply:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pkgdown<span class="sc">::</span><span class="fu">build_site</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We should now be able to see our article in the ‘Articles’ section. It should look something like the one you can see directly on this site at <a href="trade-sources-coverage.html">Trades sources coverage</a> (with some additional plots).</p>
<p>After running this command once, there is no need to rerun it every time we want to see changes, since it takes a bit longer to run. We can instead use a simpler one</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pkgdown<span class="sc">::</span><span class="fu">build_articles</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which checks for code changes in articles and only reruns those that have changed. I am not completely convinced they are equivalent, since it seems at some point one failed and one worked for me, but if you are not doing something strange (like me building this guide and writing R Markdown inside R Markdown) it should probably work the same.</p>
<p>The <code>pkgdown::build_articles()</code> one could still fail with some error indicating that the package cannot be loaded. It most likely refers to your own package. Since you use code from your own package inside the R markdown, this package itself must also be installed. When running <code>pkgdown::build_site()</code>, I think the package is installed but only in a temporary directory for that execution, so maybe it does not work anymore when calling <code>pkgdown::build_articles()</code> after that. If this is your case, you may want to try installing your own package first via <code>devtools::install()</code>. Note that this assumes you do not change your package code (the one in <code>R/</code> directory) while actively working on articles. If you do, you would have to reinstall your own package every time you change something in the <code>R/</code> directory.</p>
<p>As mentioned in a previous section, also remember to include all package dependencies your article code uses in the <code>Suggests</code> part of the <code>DESCRIPTION</code> file, so that you do not get errors of packages not being found when building the articles or running R CMD check.</p>
<p>This way we can render our articles by default in HTML, which is what browsers use. Having your own site is perfect because you can keep it up to date, but in case you need it, you should also be able to export an article as PDF. For this to work, you first need a LaTeX distribution installed. If you are on Windows, you can try MiKTeX (<a href="https://miktex.org/howto/install-miktex">maybe start from here</a>). Remember to choose “Yes” when asked for “missing packages installation on the fly”, otherwise our PDF generation from R might fail. Once we have a LaTeX distribution installed, we can build a PDF from our article with just a single command:</p>
<pre><code>rmarkdown::render("vignettes/my-vignette.Rmd", output_format = "pdf_document")</code></pre>
<p>The output PDF (probably as expected) does not look exactly like the one from the site, but it has its own style (LaTeX’s style). There are also other valid formats, you can look them up if you are curious, but I thought the PDF output format would be the most useful one besides the HTML for website generation.</p>
</section>
<section id="environment-variables-and-secrets" class="level2" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="environment-variables-and-secrets"><span class="header-section-number">8.8</span> Environment variables and secrets</h2>
<p>When running code, you can sometimes customize some behavior by specifying the value of some variable to your needs. For example, maybe there is an option whose value is a number from 1 to 5, indicating the level of debugging (the amount of output you want to see in the console, so as to understand the code’s execution). A possible way of introducing this would be with what is known as an ‘environment variable’, which is just a value stored with a name in the ‘environment’ where your code runs (not an R variable, it is more related to the operating system). These should be loaded before the code starts running, and our package workflow allows us to do this quite easily, by creating a top-level file called <code>.Renviron</code>, which can include one variable per line, like this:</p>
<pre><code>DEBUG_LEVEL=1
GOOGLESHEETS_AUTH_FILE=inst/google_cloud_key.json</code></pre>
<p>It can be accessed from R code by using</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.getenv</span>(<span class="st">"NAME_OF_VARIABLE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can also use environment variables for constants, or whatever you feel that could be used in several places. This file will be uploaded to the repository, so it is important that it does not contain any sensitive information (also known as ‘secrets’). I also introduced this section because in the example code for the <a href="#writing-articles">Writing articles</a> section, there is the line:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>key_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="fu">Sys.getenv</span>(<span class="st">"GOOGLESHEETS_AUTH_FILE"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In that example, an Excel sheet must be read. When using the <code>googlesheets4</code> package, it can automatically open a browser interactively and ask for your Google account credentials, but when running check tools, we want everything to work from beginning to end without human intervention. This is achievable by providing a secret token <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<p>Since we <em>must not</em> include secret information in <code>.Renviron</code>, the workaround is to instead add just the secret file path as an environment variable and then read from it, so the <code>.Renviron</code> is uploaded to GitHub but the secret file, which according to our environment variable should be found in <code>inst/google_cloud_key.json</code>, <em>is not uploaded</em>. Instead, the file should be uploaded to another private storage service, so that only you have access to it.</p>
<p>In examples like this one, ideally every developer would create and use their own token. The specific case of the token in this example is out of the scope of this guide, but if you are interested you could probably start from <a href="https://gargle.r-lib.org/articles/get-api-credentials.html">this <code>gargle</code> package guide</a>. Also, the <code>here</code> package was used above for easy file path referencing from the root directory of a project, so that paths are not hard-coded, and you can read more in <a href="https://here.r-lib.org/">their package site</a>.</p>
</section>
<section id="r-code-style-and-formatting" class="level2" data-number="8.9">
<h2 data-number="8.9" class="anchored" data-anchor-id="r-code-style-and-formatting"><span class="header-section-number">8.9</span> R code style and formatting</h2>
<p>There are some conventions and good practices for how to write neat code in R. The most followed style guide is the <a href="https://style.tidyverse.org/">Tidyverse style guide</a>. You can read it or just skim through it to get a grasp of their conventions. The key is that most of them can be checked automatically. There are tools which conform to these standards and let you apply the necessary changes to the code by just clicking one button. Analogously, there are also ways to check whether a code is correctly following a style or not, without explicitly changing it. In the context of the Tidyverse style guide, these two points directly match with two R packages:</p>
<ul>
<li><p><code>styler</code>: it applies the Tidyverse style guide to a specific code, be it a chunk, a file or an entire project. For example, we could apply the style to the whole package by simply using the command:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>styler<span class="sc">::</span><span class="fu">style_pkg</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Most code editors incorporate some way of doing this. Since you are most likely using RStudio, you can do it by finding the <code>styler</code> options in the ‘addins’ drop-down:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/styler_rstudio.png" class="img-fluid figure-img" alt="Use styler package from RStudio"></p>
</figure>
</div>
</div>
</div>
<p>When using <code>renv</code>, it seems RStudio only shows in the ‘addins’ drop-down the options from packages included in <code>renv</code>, so keep that in mind in case you want it in a different project, that is, if <code>styler</code> does not show up there, it means you do not have it installed in the current <code>renv</code> environment.</p>
<p>An important thing to keep in mind is that the Tidyverse style guide states lines should have at most 80 characters, but the <code>styler</code> package cannot by itself try to separate a really long single line into several lines to match the 80 character limit. You <em>must</em> fix this anyway, and the usual way for the <code>styler</code> to work is to first manually split some of the code into two lines, and then run the <code>styler</code> again, so it can now split the rest accordingly. For example, you have:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">call_my_incredibly_long_function</span>(my_first_long_argument, my_second_long_argument, my_third_long_argument)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In this case, if you use <code>styler</code> it may not change anything and still leave this code in a single line, but you can help it a bit by sending the arguments to the next line, like this:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">call_my_incredibly_long_function</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  my_first_long_argument, my_second_long_argument, my_third_long_argument)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This does not conform to the standard yet, but now trying to use <code>styler</code> again, it should be able to understand what is going on and split the code accordingly. Depending on the length of the line, it may leave it like this (note the closing parenthesis goes in its own line):</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">call_my_incredibly_long_function</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  my_first_long_argument, my_second_long_argument, my_third_long_argument</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or if the line was even longer, it would split each argument into its own line:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">call_my_incredibly_long_function</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  my_first_long_argument,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  my_second_long_argument,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  my_third_long_argument,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  my_fourth_long_argument</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Any of those should work now, because they successfully follow the 80 character per line limit. If you do not follow the limit, you would fail the <code>lintr</code> check (see next point below).</p></li>
<li><p><code>lintr</code>: it checks whether the given code/file/project follows the Tidyverse style guide, without making any actual changes. You are responsible for making sure this check passes (probably using <code>styler</code> as explained above), since it will also be automatically checked on your Pull Requests (see the <a href="#automatic-checks-on-pull-requests">next section</a> on this guide). The check we will use is:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>lintr<span class="sc">::</span><span class="fu">lint_package</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">linters =</span> lintr<span class="sc">::</span><span class="fu">linters_with_defaults</span>(<span class="at">object_usage_linter =</span> <span class="cn">NULL</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The default call would be as easy as <code>lintr::lint_package()</code>. I will not go into detail about the specific option added here, but it is there to ignore warnings about undeclared global variables, which are false positives when using <code>dplyr</code> column names. For convenience, if you are following our <a href="https://github.com/lbm364dl/R-example">example repository</a>, you could find this call in <code>inst/scripts/check_lint.R</code>, so if you want to check everything you would just have to run this script.</p>
<p>In the screenshot above you can see there are also options for <code>lintr</code> checks from Rstudio’s ‘addins’, but by default they perform the <code>lintr::lint_package()</code> call without any options. Remember we added one option to our check, so you should either find out how to change the default behavior or just run the script we included in <code>inst/scripts/check_lint.R</code>.</p></li>
</ul>
<p>Again, as you can see in the screenshot, there are more things you can do directly from RStudio (like running tests or building documentation). In this guide I tried to provide a code editor agnostic approach for everything. Since I do not use RStudio myself, I am not particularly familiar with its functionalities, so if you think they may be helpful to you, you can check them yourself.</p>
</section>
<section id="reading-large-files" class="level2" data-number="8.10">
<h2 data-number="8.10" class="anchored" data-anchor-id="reading-large-files"><span class="header-section-number">8.10</span> Reading large files</h2>
<p>Many packages don’t work with data per se. Others need data, but their datasets are small enough to be directly included in the package (and thus the code repository). GitHub has a limit on file size of <a href="https://docs.github.com/en/repositories/working-with-files/managing-large-files/about-large-files-on-github">100 MiB</a>, but even adding such files will make working with the repository noticeably slow. My recommendation for us is to consider a file <em>large</em> if it has more than a couple of megabytes. Assuming our package needs to work with <em>large</em> files, we need to find a workaround that is not storing them in GitHub. After thinking about this for a while, I considered using the <a href="https://pins.rstudio.com/articles/pins.html"><code>pins</code></a> package. I encourage you to read through that <em>Get started</em> guide, since I won’t explain too much about this package itself, but rather how we implement it in our workflow.</p>
<p>A <code>pins</code> board is like a repository but for files. You can even store a version history of them. Here we assume that someone already created a board for you. If you just want to use a file someone else already added, you don’t need any of the following. See the documentation for <code>whep_read_file()</code>. However, if you need a new file that is still not uploaded, or a new version of an existing one, you’ll need to do these steps:</p>
<ol type="1">
<li>Prepare a local version of your data. I created a script helper for us, which can be found in the <a href="https://github.com/eduaguilera/whep/blob/main/inst/scripts/prepare_upload.R"><code>whep</code> repository</a>. You have to fill your own local data path and a name for the data, run the script and follow the instructions. For example, I could set the following</li>
</ol>
<p>::: {.cell}</p>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prepare_for_upload</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="st">"~/Downloads/Processing_coefs.csv"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="st">"processing_coefs"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Creating new version '20250716T102305Z-f8189'</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ℹ 1. Manually upload the folder /tmp/RtmpHFHNUO/pins-1f3c39c418e0/processi</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ng_coefs/20250716T102305Z-f8189 into your board. Folder path copied to you</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; r clipboard.</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ℹ 2. Add the corresponding line</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; - processing_coefs/20250716T102305Z-f8189/</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; in _pins.yaml at the end of the 'processing_coefs:' section</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ℹ 3. If you want the package to use this version, add a new row to whep_in</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; puts.csv if it's a new file or update the version in the existing row. The</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  version is 20250716T102305Z-f8189.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
<ol start="2" type="1">
<li>A temporary local folder is created whose name is the data version. You must upload this folder inside the one with the data’s name in the public board, assuming you have write access.</li>
</ol>
<p>::: {.cell} ::: {.cell-output-display} <img src="imgs/new_version_uploaded.png" class="img-fluid" alt="New version uploaded"> ::: :::</p>
<ol start="3" type="1">
<li>You must add one line to the <code>_pins.yaml</code> file in the root folder of the board, like it’s specified in the instructions. This is an internal file that the <code>pins</code> package uses to keep track of files and versions.</li>
</ol>
<p>::: {.cell} ::: {.cell-output-display} <img src="imgs/update_pins_yaml.png" class="img-fluid" alt="Update _pins.yaml"> ::: :::</p>
<ol start="4" type="1">
<li>To use the version in the next package release, you must also update the version inside the <a href="https://github.com/eduaguilera/whep/blob/main/inst/extdata/whep_inputs.csv"><code>whep_inputs.csv</code></a> file:</li>
</ol>
<pre><code>alias,board_url,version
...
processing_coefs,https://some/url/to/_pins.yaml,20250716T102305Z-f8189
...</code></pre>
<p>And now you’re done. You added a new file or a new version, and you can now access it from the code by using the <code>whep_read_file()</code> function.</p>
<p>If you’re wondering why there are manual steps in this process and the script doesn’t automate everything, it’s because our storage service is hosted by a Nextcloud server, and the easiest way to interact with it from outside is having a synced version of the whole storage locally. I thought some people might not be able to afford that, and since we don’t have to upload new data files often, I decided a few manual steps wouldn’t hurt that much.</p>
</section>
<section id="automatic-checks-on-pull-requests" class="level2" data-number="8.11">
<h2 data-number="8.11" class="anchored" data-anchor-id="automatic-checks-on-pull-requests"><span class="header-section-number">8.11</span> Automatic checks on Pull Requests</h2>
<p>By this point we assume you are already done with all your new code, you documented and tested it, or perhaps you just created some report in the form of an article. As we have seen in the <a href="#git-intro">Git intro</a>, it is now time to create a Pull Request so that someone else reviews what you have done. But when you create the Pull Request, our workflow is designed so that two checks are run automatically on GitHub, each time you push your changes to a branch which has an open Pull Request:</p>
<ul>
<li>First, the R CMD check is performed. We have seen in a previous section how you can run it locally, so you should have made sure it outputs no errors. Otherwise, you will see this step failing.</li>
<li>Then, a linting check is performed. We have also seen how to autoformat your code, so that it follows the R code styling standards, and how to make sure that it is indeed well formatted. Otherwise, you will see this step failing.</li>
</ul>
<p>If any of the steps above fail, you will see something like this in your PR page:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/github_action_fail.png" class="img-fluid figure-img" alt="GitHub Action check fails"></p>
</figure>
</div>
</div>
</div>
<p>Otherwise, if both checks succeeded, you will see something like:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/github_action_pass.png" class="img-fluid figure-img" alt="GitHub Action check succeeds"></p>
</figure>
</div>
</div>
</div>
<p>Overall, you should be able to see this at the bottom of the PR:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="imgs/all_pr_ok.png" class="img-fluid figure-img" alt="GitHub Action Pull Request passed"></p>
</figure>
</div>
</div>
</div>
<p>In case you are wondering, both checks we mentioned before are actually done in a single GitHub automatic step (these steps are called ‘GitHub actions’), so it should say ‘1 successful check’ instead of ‘2 successful checks’. However, there is an additional GitHub action there, which essentially just updates the documentation site (only when the PR is actually merged into the main branch). This is not relevant to you as a developer but it makes the overall workflow easier, since the project documentation is automatically updated without any more human intervention. If you want to know more about this automatic site update you can check this <a href="https://r-pkgs.org/website.html">section from the R Packages book</a>.</p>
<p>Recall that for a PR to be accepted and merged into the main branch, it must also be reviewed by another developer. A good practice would be to make sure the GitHub checks pass before even asking for someone’s reviewing, because if any check failed you most likely need to add more code changes to fix them, so some of the code the reviewer could have checked before could become obsolete, and they would have to read it again, so we better avoid that.</p>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>If you copy it, please <strong>remove the _ from starting code block lines, e.g., change <code>```_{r, ...}</code> to <code>```{r, ...}</code></strong>. I cannot render R Markdown code properly inside an R Markdown file itself in this guide, because it tries to execute the code block anyway, and this is a workaround so that this guide renders properly. Do tell me if you know of a correct way to handle this.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>For educational purposes I won’t change anything from this explanation in the guide. However, recently I found out that the token is not needed when you’re reading public files. For this to work automatically we only have to call <code>googlesheets4::gs4_deauth()</code> before reading the public file.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./r.html" class="pagination-link" aria-label="R part">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">R part</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./intro.html" class="pagination-link" aria-label="Introduction">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Introduction</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>